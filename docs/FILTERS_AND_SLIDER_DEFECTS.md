# تقرير عيوب الفلاتر و Slider السعر

## 1. عيوب Slider السعر (Price Slider)

### 1.1 تنسيق السعر بلغية ثابتة (`formatPrice`)
- **الملف:** `resources/js/app.js`
- **المشكلة:** الدالة تستخدم `'ar-SA'` ثابتاً بغض النظر عن لغة التطبيق (`app()->getLocale()`).
- **التأثير:** في الواجهة الإنجليزية تُعرض الأرقام بتنسيق عربي (مثل فواصل عربية).
- **الإصلاح:** استخدام `document.documentElement.lang` أو تمرير locale من Blade (مثلاً `data-locale`) واستخدامه في `Intl.NumberFormat`.

### 1.2 حد أدنى للفجوة بين Min و Max (`minGap = 10000`)
- **الملف:** `resources/js/app.js`
- **المشكلة:** لا يمكن اختيار نطاق ضيق مثل 0–5,000 أو 100–500؛ الـ slider يفرض فرقاً لا يقل عن 10,000.
- **التأثير:** تجربة استخدام سيئة عند البحث عن أسعار منخفضة أو نطاقات صغيرة.
- **الإصلاح:** تقليل `minGap` (مثلاً 100 أو 500) أو جعله مرناً حسب المدى، أو إزالته إن لم يكن مطلوباً.

### 1.3 تداخل الـ Thumbs عند التقارب
- **الملف:** `public/css/components/filters.css` + بنية الـ slider
- **المشكلة:** كلا الـ range inputs لهما `z-index: 2`؛ عند تقارب Min و Max يصعب سحب الـ thumb الأيسر لأن الـ max يعلوه.
- **التأثير:** صعوبة التحكم في النطاق عند القيم المتقاربة.
- **الإصلاح:** رفع `z-index` للـ input الذي يُسحب (مثلاً عند `:active` أو `:focus`) أو استخدام منطق يرفع أولوية الـ thumb الأقرب للمؤشر.

### 1.4 عدم إمكانية النقر على المسار (Track) للقفز
- **الملف:** `public/css/components/filters.css`
- **المشكلة:** الـ inputs لها `pointer-events: none` والـ thumbs فقط `pointer-events: all`؛ لا يمكن النقر على الـ track للقفز إلى نقطة.
- **التأثير:** تفاعل أقل من المتوقع في واجهات الـ range المألوفة.
- **الإصلاح:** إما تمكين `pointer-events` على الـ track مع معالجة النقر عبر JS، أو الإبقاء على الوضع الحالي مع توثيقه كتصميم مقصود.

### 1.5 خطأ في CSS: `::-webkit-slider-thumb::before`
- **الملف:** `public/css/components/filters.css` (حوالي السطر 312)
- **المشكلة:** `::before` على pseudo-element غير مدعوم في المواصفات؛ القواعد لا تعمل.
- **التأثير:** لا تأثير فعلي (كود ميت).
- **الإصلاح:** حذف القواعد الخاصة بـ `::-webkit-slider-thumb::before`.

### 1.6 تعارض `transform` على الـ thumb مع `:hover` / `:active`
- **الملف:** `public/css/components/filters.css`
- **المشكلة:** `transform: scale(1.2)` على `:hover` و `scale(1.15)` على `:active` للـ thumb؛ الـ thumb نفسه `position: relative` داخل الـ input. قد يؤثر الـ transform على الموضع المحسوب في بعض المتصفحات.
- **التأثير:** احتمال زلق طفيف أو عدم اتساق في الشكل عند السحب (نادر).
- **الإصلاح:** مراجعة استخدام `transform` والـ stacking context؛ استخدام `transform-origin: center` إن لزم.

### 1.7 قيم ابتدائية عند `price_min > price_max` (من الخلفية)
- **الملف:** `resources/js/app.js`
- **المشكلة:** إذا أتى من الخلفية `price_min > price_max`، الحساب يجلِب `initialMin` و `initialMax` متساويين (مثلاً 1,000,000)، فينعدم النطاق المرئي.
- **التأثير:** slider يبدو "مكسوراً" أو غير قابل للاستخدام عند بيانات خاطئة.
- **الإصلاح:** تطبيع القيم (مثلاً إرجاع `min` و `max` الافتراضيين) عندما `price_min > price_max`.

### 1.8 عدم توافق كامل مع RTL
- **الملف:** `public/css/components/filters.css` (قسم RTL)
- **المشكلة:** التعديلات RTL للموجودات على الـ labels والـ limits فقط؛ الـ track والـ range لا يُعكسان. السلوك البصري قد يبدو معكوساً في واجهة RTL.
- **التأثير:** التباس بسيط للمستخدمين في وضع RTL.
- **الإصلاح:** توحيد الاتجاه باستخدام خصائص منطقية (مثل `inset-inline-*`) أو عكس الـ track/range في RTL مع الحفاظ على منطق Min/Max.

### 1.9 خطوة ثابتة `step="1000"`
- **الملف:** `resources/views/public/items/_partials/filters.blade.php`
- **المشكلة:** لا يمكن اختيار قيم مثل 500 أو 1,500.
- **التأثير:** قد يكون مقصوداً؛ إن لم يكن، فهو قيد على دقة النطاق.
- **الإصلاح:** تخفيض الـ step (مثلاً 100) أو جعله مرتبطاً بالمدى، أو توثيق التصميم الحالي.

---

## 2. عيوب الفلاتر العامة

### 2.1 **حرجة** تسطيح الشجرة لـ Chips الفئة (`flatten`)
- **الملف:** `resources/views/public/items/_partials/filters.blade.php` (حوالي السطر 24)
- **المشكلة:** `$categories->flatten()` على شجرة أب/أبناء لا يفلطح العلاقة `children`؛ البنية المعطاة للـ view هي `[Parent1, Parent2, ...]` فقط. الـ `flatten` لا يضم الأبناء.
- **التأثير:** عند اختيار **فئة فرعية (child)**، `firstWhere('id', $currentFilters['category_id'])` لا يجدها، فلا يظهر اسم الفئة في الـ chip أو يظهر سلوك غير متوقع.
- **الإصلاح:** استبدال `flatten()` بتسوية صريحة للشجرة، مثلاً:
  ```php
  $flat = $categories->flatMap(fn ($c) => collect([$c])->merge($c->children ?? collect()));
  $category = $flat->firstWhere('id', $currentFilters['category_id']);
  ```

### 2.2 حذف `operation_type` عند "مسح الكل" و "إعادة تعيين"
- **الملف:** `resources/views/public/items/_partials/filters.blade.php`
- **المشكلة:** روابط "مسح الكل" و "إعادة التعيين" تحافظ على `operation_type` في الـ URL فقط عندما يكون موجوداً. التعامل صحيح، لكن إن كان تصميم المنتج يفرض الاحتفاظ بـ `operation_type` دائماً (مثلاً صفحة "إعلانات للبيع فقط") فقد يحتاج توضيح.
- **التأثير:** خفيف؛ يعتمد على متطلبات المنتج.
- **الإصلاح:** مراجعة المتطلبات؛ إن كان يجب الاحتفاظ بـ `operation_type` حتى بعد "مسح الكل"، تعديل الـ `removeUrl` وروابط الإعادة وفق ذلك.

### 2.3 عدم إرسال تلقائي للنموذج عند تغيير السعر
- **الملف:** `resources/views/public/items/_partials/filters.blade.php`
- **المشكلة:** نوع العملية، الفئة، والحالة ترسل النموذج تلقائياً (`onchange="this.form.submit()"`)؛ الـ price slider لا يرسل.
- **التأثير:** تناقض في السلوك: المستخدم يغير السعر ثم يضطر للضغط على "تطبيق الفلاتر".
- **الإصلاح:** إما إضافة إرسال تلقائي عند انتهاء السحب (مثلاً في `onDragEnd`) أو توثيق أن السعر يتطلب ضغط "تطبيق" بشكل مقصود.

### 2.4 الاحتفاظ بـ `sort` و `per_page` فقط عند الإرسال
- **الملف:** `resources/views/public/items/_partials/filters.blade.php`
- **المشكلة:** النموذج يرسل `sort` و `per_page` كـ hidden عند وجودهما؛ أي استعلامات أخرى (مثل `foo=1`) تُفقد عند تطبيق الفلاتر.
- **التأثير:** متوسط إن كانت هناك أبعاد أخرى يجب الاحتفاظ بها.
- **الإصلاح:** الاحتفاظ بكل الـ query params غير المتعارضة مع الفلاتر (مثلاً `request()->except([...])` مع إعادة إضافة الفلاتر الحالية)، أو توثيق القائمة المعتمدة.

### 2.5 دعم `:has()` في CSS
- **الملف:** `public/css/components/filters.css`
- **المشكلة:** استخدام `:has()` لتفعيل أنماط عند hover/active الـ slider. غير مدعوم في متصفحات قديمة.
- **التأثير:** تحسينات بصرية فقط؛ الـ slider يعمل بدونها.
- **الإصلاح:** إما تقديم بدائل لمتصفحات قديمة أو اعتمادها كـ progressive enhancement.

---

## 3. خلاصة أولوية الإصلاح وحالة الإصلاح

| الأولوية | العيب | النوع | **تم الإصلاح؟** |
|----------|--------|-------|------------------|
| عالية | 2.1 تسطيح الشجرة لـ chips الفئة | منطق | ✅ نعم |
| عالية | 1.7 تطبيع price_min > price_max | منطق | ✅ نعم |
| عالية | 1.1 `formatPrice` واللغة | تجربة مستخدم | ✅ نعم |
| متوسطة | 1.5 حذف `::before` على thumb | تنظيف | ✅ نعم |
| متوسطة | 1.2 minGap والمدى الضيق | تجربة مستخدم | ✅ نعم |
| متوسطة | 1.3 تداخل الـ thumbs | تفاعل | ✅ نعم |
| منخفضة | 1.4 النقر على الـ track | تفاعل | ✅ نعم |
| منخفضة | 1.6 تعارض transform | تحسين | ✅ نعم |
| منخفضة | 1.8 RTL كامل | تحسين | ✅ نعم |
| منخفضة | 1.9 step ثابت | تحسين | ✅ نعم |
| منخفضة | 2.2 operation_type | تحسين | ✅ كان محافظاً عليه مسبقاً |
| منخفضة | 2.3 إرسال تلقائي عند السحب | تحسين | ✅ نعم |
| منخفضة | 2.4 الاحتفاظ بكل query params | تحسين | ✅ نعم |
| منخفضة | 2.5 :has() | تحسين | ✅ توثيق كـ progressive enhancement |

**ملخص:** تم إصلاح جميع العيوب الـ 14.

---

## 4. الإصلاحات المطبقة (ملخص تقني)

- **1.1** `formatPrice`: استخدام `document.documentElement.lang` في `Intl.NumberFormat`.
- **1.2** `minGap`: تخفيض من 10,000 إلى 500.
- **1.3** تداخل الـ thumbs: إضافة `isDraggingMin` / `isDraggingMax` ورفع `z-index` للـ input المسحوب عبر `.khezana-price-slider-wrapper--dragging-min/max`.
- **1.4** نقر الـ track: `@click="onTrackClick($event)"` على الـ track، `pointer-events: none` على الـ range، `onTrackClick` يحسب النسبة ويحدّث الأقرب (min/max).
- **1.5** إزالة قواعد `::-webkit-slider-thumb::before`.
- **1.6** إضافة `transform-origin: center` لجميع الـ thumbs.
- **1.7** تطبيع `price_min` / `price_max` عند `price_min > price_max` (إعادة تعيين إلى 0–1,000,000).
- **1.8** استخدام `inset-inline-start` / `inset-inline-end` للـ track والـ inputs مع fallback `left`/`right`؛ RTL labels وlimits كما هي.
- **1.9** تغيير `step` من 1000 إلى 100.
- **2.1** استبدال `flatten()` بـ `flatMap` لتسوية شجرة الفئات (أب + أبناء).
- **2.2** الإبقاء على `operation_type` في "مسح الكل" و"إعادة التعيين" عند وجوده في الـ URL (لم يُغيّر).
- **2.3** إرسال النموذج تلقائياً في `onDragEnd` عند تغيّر القيم فقط.
- **2.4** حفظ كل الـ query params عبر `request()->except([فلاتر, page])` وحلقة hidden inputs (بما فيها `sort`, `per_page`).
- **2.5** توثيق `:has()` كـ progressive enhancement؛ لا fallback إضافي.

---

*تم إعداد التقرير بناءً على مراجعة الكود في: الفلاتر، slider السعر، خدمات الفئات، واستعلامات التصفح.*
